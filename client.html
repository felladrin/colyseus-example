<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width" />
    <script src="https://unpkg.com/colyseus.js@^0.14.12/dist/colyseus.js"></script>
    <script src="https://unpkg.com/crypto-js@^4.0.0/core.js"></script>
    <script src="https://unpkg.com/crypto-js@^4.0.0/md5.js"></script>
    <style type="text/css">
      .player {
        width: 80px;
        height: 80px;
        position: absolute;
        box-sizing: border-box;
        border-radius: 9999px;
      }

      .controller {
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="controller">
      <button id="upButton">&uarr;</button>
      <br />
      <button id="leftButton">&larr;</button>
      <button id="rightButton">&rarr;</button>
      <br />
      <button id="downButton">&darr;</button>
    </div>
    <script>
      new Colyseus.Client(
        `${location.protocol.replace(
          "http",
          "ws"
        )}//${window.document.location.host.replace(/:.*/, "")}${
          location.port ? ":" + location.port : ""
        }`
      )
        .joinOrCreate("main")
        .then((room) => {
          const players = {};
          const colors = ["red", "green", "yellow", "blue", "cyan", "magenta"];

          room.state.players.onAdd = (player, sessionId) => {
            const gravatarHash = CryptoJS.MD5(
              `${sessionId}@example.com`
            ).toString();

            const dom = document.createElement("div");
            dom.className = "player";
            dom.title = `Player ${sessionId}`;
            dom.style.left = player.x + "px";
            dom.style.top = player.y + "px";
            dom.style.backgroundImage = `url("https://www.gravatar.com/avatar/${gravatarHash}?d=robohash")`;
            dom.style.backgroundPosition = `center`;
            dom.style.backgroundRepeat = `no-repeat`;
            dom.style.backgroundSize = `cover`;

            player.onChange = (changes) => {
              dom.style.left = player.x + "px";
              dom.style.top = player.y + "px";
            };

            players[sessionId] = dom;
            document.body.appendChild(dom);
          };

          room.state.players.onRemove = (player, sessionId) => {
            document.body.removeChild(players[sessionId]);
            delete players[sessionId];
          };

          room.onMessage("greetings", (message) => {
            console.log(message);
          });

          const moveUp = () => room.send("move", { y: -1 });
          const moveRight = () => room.send("move", { x: 1 });
          const moveDown = () => room.send("move", { y: 1 });
          const moveLeft = () => room.send("move", { x: -1 });

          document.getElementById("upButton").addEventListener("click", moveUp);
          document
            .getElementById("downButton")
            .addEventListener("click", moveDown);
          document
            .getElementById("leftButton")
            .addEventListener("click", moveLeft);
          document
            .getElementById("rightButton")
            .addEventListener("click", moveRight);

          const keyCodeToActionMap = {
            37: moveLeft,
            38: moveUp,
            39: moveRight,
            40: moveDown,
          };

          window.addEventListener("keydown", (e) => {
            if (keyCodeToActionMap[e.which]) {
              keyCodeToActionMap[e.which]();
            }
          });
        });
    </script>
  </body>
</html>
